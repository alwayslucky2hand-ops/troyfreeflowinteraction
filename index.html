<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº¤æµè«–å£‡</title>
    <style>
        /* NotebookLM æ¥µç°¡å­¸è¡“é¢¨æ ¼ï¼šç„¡å‹•ç•«ã€å…¨éœæ…‹ã€é«˜å°æ¯”ã€é‡è¦–å…§å®¹ */
        :root {
            --bg-color: #f8f9fa;
            --surface-color: #ffffff;
            --border-color: #dadce0;
            --text-main: #202124;
            --text-muted: #5f6368;
            --primary-color: #1a73e8;
            --primary-hover: #174ea6;
        }
        
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg-color); color: var(--text-main); margin: 0; padding: 15px; line-height: 1.6; }
        .container { max-width: 680px; margin: 0 auto; }
        
        /* é ‚éƒ¨æœå°‹å€ */
        .header { margin-bottom: 20px; border-bottom: 2px solid var(--text-main); padding-bottom: 15px; }
        .header h1 { margin: 0 0 10px 0; font-size: 1.5rem; letter-spacing: -0.02em; }
        .search-box { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; }
        .search-box:focus { outline: 2px solid var(--primary-color); border-color: transparent; }

        /* å¡ç‰‡èˆ‡å‚ç›´è¡¨å–®è¨­è¨ˆ */
        .panel { background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 6px; padding: 20px; margin-bottom: 20px; }
        .panel-title { margin: 0 0 15px 0; font-size: 1.1rem; font-weight: 600; }
        
        .form-group { display: flex; flex-direction: column; margin-bottom: 15px; }
        .form-group label { font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; background: #fff; }
        .form-group textarea { min-height: 100px; resize: vertical; }

        button { background: var(--text-main); color: #fff; border: none; padding: 12px 20px; border-radius: 4px; font-weight: 600; font-size: 1rem; cursor: pointer; width: 100%; }
        button:hover { background: #000; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        button.btn-reply { background: transparent; color: var(--text-muted); border: 1px solid var(--border-color); margin-top: 10px; }
        button.btn-reply:hover { background: #f1f3f4; color: var(--text-main); }

        /* è²¼æ–‡å‘ˆç¾ */
        .post-header { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 10px; font-size: 0.85rem; }
        .badge { background: #e8eaed; color: var(--text-main); padding: 2px 8px; border-radius: 4px; font-weight: 500; }
        .post-time { color: var(--text-muted); font-size: 0.8rem; margin-left: auto; }
        .post-content { font-size: 1.05rem; white-space: pre-wrap; margin-bottom: 15px; word-break: break-word; }
        
        /* åª’é«”å€å¡Š */
        .media-box { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .media-box img { max-width: 100%; border-radius: 4px; border: 1px solid var(--border-color); }
        .media-box iframe { width: 100%; height: 250px; border-radius: 4px; border: 1px solid var(--border-color); }

        /* ç•™è¨€å€å¡Š */
        .replies-wrapper { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .reply-item { background: #f8f9fa; border-left: 3px solid var(--border-color); padding: 12px 15px; margin-bottom: 10px; }
        
        .system-msg { text-align: center; color: var(--text-muted); padding: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>äº¤æµè«–å£‡</h1>
        <input type="text" id="searchInput" class="search-box" placeholder="è¼¸å…¥é—œéµå­—æœå°‹è²¼æ–‡æˆ–ç•™è¨€..." oninput="filterPosts()">
    </div>

    <div class="panel">
        <h3 class="panel-title">ç™¼èµ·æ–°è¨è«–</h3>
        
        <div class="form-group">
            <label>æš±ç¨± (å¿…å¡«)</label>
            <input type="text" id="p_nickname" placeholder="æ‚¨çš„æš±ç¨±">
        </div>
        
        <div class="form-group">
            <label>æ€§åˆ¥</label>
            <select id="p_gender">
                <option value="ä¸é€éœ²">ä¸é€éœ²</option>
                <option value="ç”·">ç”·</option>
                <option value="å¥³">å¥³</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>è·ç¨± / å¹´é½¡ / å±…ä½åœ°</label>
            <div style="display:flex; gap:10px;">
                <input type="text" id="p_job" placeholder="è·ç¨± (é¸å¡«)">
                <select id="p_age">
                    <option value="ä¸é€éœ²">å¹´é½¡</option>
                    <option value="20æ­²ä»¥ä¸‹">20ä»¥ä¸‹</option>
                    <option value="21-30æ­²">21-30</option>
                    <option value="31-40æ­²">31-40</option>
                    <option value="41æ­²ä»¥ä¸Š">41ä»¥ä¸Š</option>
                </select>
                <input type="text" id="p_location" placeholder="å±…ä½åœ° (é¸å¡«)">
            </div>
        </div>

        <div class="form-group">
            <label>è¨è«–å…§å®¹ (å¿…å¡«ï¼Œæ”¯æ´è²¼ä¸Šå¤–éƒ¨ç¶²å€)</label>
            <textarea id="p_content" placeholder="è«‹æè¿°æ‚¨çš„å•é¡Œæˆ–åˆ†äº«è³‡è¨Š..."></textarea>
        </div>

        <div class="form-group">
            <label>é™„åŠ åœ–ç‰‡æˆ–å½±ç‰‡ (å°‡è‡ªå‹•å»ºæª”è‡³ Google Drive)</label>
            <input type="file" id="p_files" multiple accept="image/*,video/*">
        </div>

        <button id="btnSubmitPost" onclick="submitPost()">ğŸš€ ç™¼ä½ˆæ–‡ç« </button>
    </div>

    <div id="loadingMsg" class="system-msg">å³æ™‚åŒæ­¥è³‡æ–™ä¸­...</div>
    <div id="postsContainer"></div>
</div>

<script>
    // ğŸš¨ è«‹æ›¿æ›æˆä½ å‰›å‰›å»ºç«‹çš„ã€Œè«–å£‡å°ˆå±¬ GAS API ç¶²å€ã€
    const API_URL = 'https://script.google.com/macros/s/AKfycbzCYjn1RlPAvjKYwoHjYS9tiQaXmA7WvLdwRRZxUka1hj96WfqpdkmrFdMY7r4Pn8nZxQ/exec'; 
    let allData = [];

    window.onload = loadPosts;

    // æŠ“å–æ–‡ç«  (åŠ ä¸Šæ™‚é–“æˆ³ç ´è§£å¿«å–)
    async function loadPosts() {
        document.getElementById('loadingMsg').style.display = 'block';
        try {
            const cacheBuster = new Date().getTime();
            const res = await fetch(`${API_URL}?action=getPosts&t=${cacheBuster}`);
            const data = await res.json();
            
            if (data.error) throw new Error(data.error);
            allData = data;
            renderPosts(allData);
        } catch (e) {
            document.getElementById('loadingMsg').innerText = "è¼‰å…¥å¤±æ•—ï¼š" + e.message;
        }
    }

    // æ¸²æŸ“ç•«é¢é‚è¼¯
    function renderPosts(dataArray) {
        const container = document.getElementById('postsContainer');
        container.innerHTML = '';
        document.getElementById('loadingMsg').style.display = 'none';

        const mainPosts = dataArray.filter(p => !p.parentID);
        const replies = dataArray.filter(p => p.parentID);

        if (mainPosts.length === 0) {
            container.innerHTML = '<div class="system-msg">ç›®å‰å°šç„¡è¨è«–ï¼Œä¾†ç™¼ç¬¬ä¸€ç¯‡æ–‡ç« å§ï¼</div>';
            return;
        }

        mainPosts.forEach(post => {
            // è™•ç†åª’é«”é¡¯ç¤º
            let mediaHtml = '';
            if (post.media && post.media.length > 0) {
                post.media.forEach(m => {
                    if (m.isAutoVideo) {
                        mediaHtml += `<iframe src="https://drive.google.com/file/d/${m.id}/preview" allowfullscreen></iframe>`;
                    } else {
                        // ä½¿ç”¨ Google ç›´é€£æ ¼å¼é¡¯ç¤ºåœ–ç‰‡
                        mediaHtml += `<img src="https://lh3.googleusercontent.com/d/${m.id}" alt="${m.name}">`;
                    }
                });
            }

            // è™•ç†å›è¦†é¡¯ç¤º
            const postReplies = replies.filter(r => r.parentID === post.postID).reverse(); // ç•™è¨€èˆŠçš„åœ¨ä¸Šé¢
            let repliesHtml = '';
            postReplies.forEach(r => {
                repliesHtml += `
                    <div class="reply-item">
                        <div class="post-header" style="margin-bottom:5px;">
                            <strong>${r.nickname}</strong>
                            ${r.jobTitle !== 'ä¸é€éœ²' ? `<span class="badge">${r.jobTitle}</span>` : ''}
                            <span class="post-time">${formatDate(r.timestamp)}</span>
                        </div>
                        <div class="post-content" style="font-size:0.95rem; margin-bottom:0;">${linkify(escapeHtml(r.content))}</div>
                    </div>
                `;
            });

            // çµ„åˆå–®ç¯‡è²¼æ–‡ HTML
            const html = `
                <div class="panel">
                    <div class="post-header">
                        <strong style="font-size:1.1rem;">${post.nickname}</strong>
                        ${post.gender !== 'ä¸é€éœ²' ? `<span class="badge">${post.gender}</span>` : ''}
                        ${post.jobTitle !== 'ä¸é€éœ²' ? `<span class="badge">${post.jobTitle}</span>` : ''}
                        ${post.age !== 'ä¸é€éœ²' ? `<span class="badge">${post.age}</span>` : ''}
                        ${post.location !== 'ä¸é€éœ²' ? `<span class="badge">${post.location}</span>` : ''}
                        <span class="post-time">${formatDate(post.timestamp)}</span>
                    </div>
                    
                    <div class="post-content">${linkify(escapeHtml(post.content))}</div>
                    ${mediaHtml ? `<div class="media-box">${mediaHtml}</div>` : ''}
                    
                    <button class="btn-reply" onclick="toggleReplyForm('${post.postID}')">ğŸ’¬ åƒèˆ‡è¨è«– (${postReplies.length})</button>

                    <div class="replies-wrapper">
                        ${repliesHtml}
                        
                        <div id="reply-form-${post.postID}" style="display:none; margin-top:15px;">
                            <div class="form-group">
                                <input type="text" id="r_nickname_${post.postID}" placeholder="æ‚¨çš„æš±ç¨± (å¿…å¡«)">
                            </div>
                            <div class="form-group">
                                <textarea id="r_content_${post.postID}" placeholder="å¯«ä¸‹æ‚¨çš„å›è¦†... (å¿…å¡«)"></textarea>
                            </div>
                            <button onclick="submitReply('${post.postID}')">é€å‡ºå›è¦†</button>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += html;
        });
    }

    function toggleReplyForm(id) {
        const form = document.getElementById(`reply-form-${id}`);
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    // ç™¼ä½ˆä¸»æ–‡ (å³æ™‚æ›´æ–°å„ªåŒ–)
    async function submitPost() {
        const nickname = document.getElementById('p_nickname').value.trim();
        const content = document.getElementById('p_content').value.trim();
        const fileInput = document.getElementById('p_files');
        const btn = document.getElementById('btnSubmitPost');
        
        if (!nickname || !content) return alert("æš±ç¨±èˆ‡å…§å®¹ç‚ºå¿…å¡«ï¼");
        
        btn.innerText = "â³ è™•ç†ä¸Šå‚³ä¸­ï¼Œè«‹ç¨å€™...";
        btn.disabled = true;

        try {
            const filesData = await processFiles(fileInput.files);
            const payload = {
                action: 'addPost',
                payload: {
                    nickname: nickname,
                    gender: document.getElementById('p_gender').value,
                    jobTitle: document.getElementById('p_job').value || 'ä¸é€éœ²',
                    age: document.getElementById('p_age').value,
                    location: document.getElementById('p_location').value || 'ä¸é€éœ²',
                    content: content,
                    files: filesData
                }
            };
            
            await sendToServer(payload);
            
            // ğŸŒŸ å³æ™‚é¡¯ç¤ºå„ªåŒ–ï¼šæ¸…ç©ºè¡¨å–®ï¼Œä¸¦ç›´æ¥é‡æ–°æŠ“å–è³‡æ–™ï¼Œä¸åˆ·æ–°ç¶²é ï¼
            document.getElementById('p_content').value = '';
            document.getElementById('p_files').value = '';
            await loadPosts(); 
            window.scrollTo(0, 0); // æ»¾å›é ‚éƒ¨çœ‹æ–°æ–‡ç« 
            
        } catch (e) {
            alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + e);
        } finally {
            btn.innerText = "ğŸš€ ç™¼ä½ˆæ–‡ç« ";
            btn.disabled = false;
        }
    }

    // ç™¼ä½ˆå›è¦† (å³æ™‚æ›´æ–°å„ªåŒ–)
    async function submitReply(parentID) {
        const nickname = document.getElementById(`r_nickname_${parentID}`).value.trim();
        const content = document.getElementById(`r_content_${parentID}`).value.trim();
        const btn = event.target;
        
        if (!nickname || !content) return alert("æš±ç¨±èˆ‡å›è¦†å…§å®¹ç‚ºå¿…å¡«ï¼");
        
        btn.innerText = "å‚³é€ä¸­...";
        btn.disabled = true;

        const payload = {
            action: 'addPost',
            payload: {
                parentID: parentID,
                nickname: nickname,
                content: content,
                files: [] 
            }
        };
        
        try {
            await sendToServer(payload);
            // ğŸŒŸ å³æ™‚é¡¯ç¤ºå„ªåŒ–ï¼šç›´æ¥é‡æ–°æŠ“å–è³‡æ–™
            await loadPosts();
        } catch (e) {
            alert("å›è¦†å¤±æ•—ï¼š" + e);
            btn.innerText = "é€å‡ºå›è¦†";
            btn.disabled = false;
        }
    }

    // è™•ç†æª”æ¡ˆè½‰ Base64
    async function processFiles(files) {
        let result = [];
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const base64 = await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            result.push({ name: file.name, mimeType: file.type, base64: base64 });
        }
        return result;
    }

    // å‘¼å« GAS
    async function sendToServer(data) {
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.error) throw new Error(result.error);
        return result;
    }

    // é—œéµå­—æœå°‹
    function filterPosts() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        if (!query) return renderPosts(allData);
        
        const filtered = allData.filter(p => 
            (p.nickname && p.nickname.toLowerCase().includes(query)) || 
            (p.content && p.content.toLowerCase().includes(query)) ||
            (p.jobTitle && p.jobTitle.toLowerCase().includes(query))
        );
        renderPosts(filtered);
    }

    // å·¥å…·ï¼šé˜²æ­¢ XSS èˆ‡è‡ªå‹•è½‰ç¶²å€
    function escapeHtml(text) { return text.replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
    function linkify(text) {
        return text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:#1a73e8; font-weight:500;">$1</a>');
    }
    function formatDate(dateStr) {
        try { const d = new Date(dateStr); return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; } catch(e){ return dateStr; }
    }
</script>

</body>
</html>
