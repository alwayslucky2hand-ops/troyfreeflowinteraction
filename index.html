<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­äº¤æµè«–å£‡</title>
    <style>
        /* NotebookLM æ¥µç°¡å­¸è¡“é¢¨æ ¼ï¼šç„¡å‹•ç•«ã€ç„¡é™°å½±ã€ç›´è§’/å¾®åœ“è§’ã€é«˜å°æ¯” */
        :root {
            --bg-color: #f8f9fa;
            --surface-color: #ffffff;
            --border-color: #dadce0;
            --text-main: #202124;
            --text-secondary: #5f6368;
            --primary-action: #1a73e8;
            --primary-hover: #174ea6;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* æ¨™é¡Œèˆ‡æœå°‹ */
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        h1 { margin: 0; font-size: 1.5rem; font-weight: 600; color: var(--text-main); }
        .search-bar { padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; width: 250px; font-size: 0.95rem; }
        .search-bar:focus { outline: 2px solid var(--primary-action); border-color: transparent; }

        /* å¡ç‰‡å…±ç”¨æ¨£å¼ (éœæ…‹) */
        .panel { background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin-bottom: 16px; }
        
        /* è¡¨å–®æ¨£å¼ */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 12px; }
        label { font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 4px; }
        input[type="text"], select, textarea { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.95rem; background: #fff; }
        textarea { resize: vertical; min-height: 80px; }
        
        /* æŒ‰éˆ•æ¨£å¼ (ç„¡éæ¸¡å‹•ç•«) */
        button { background-color: var(--primary-action); color: white; border: none; padding: 8px 16px; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 0.95rem; }
        button:hover { background-color: var(--primary-hover); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-secondary { background-color: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background-color: #f1f3f4; }

        /* è²¼æ–‡å‘ˆç¾ */
        .post-meta { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; font-size: 0.85rem; }
        .tag { background-color: #e8eaed; color: var(--text-main); padding: 2px 8px; border-radius: 12px; }
        .post-content { white-space: pre-wrap; font-size: 1rem; margin-bottom: 16px; }
        .post-time { font-size: 0.8rem; color: var(--text-secondary); }
        
        /* åª’é«”å‘ˆç¾å€ */
        .media-container { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .media-container img { max-width: 100%; border: 1px solid var(--border-color); border-radius: 4px; }
        .media-container iframe { width: 100%; height: 350px; border: 1px solid var(--border-color); border-radius: 4px; }

        /* å›è¦†å€å¡Š */
        .reply-section { margin-top: 16px; padding-top: 16px; border-top: 1px dashed var(--border-color); margin-left: 20px; border-left: 3px solid #e8eaed; padding-left: 16px; }
        .reply-item { margin-bottom: 12px; background: #f8f9fa; padding: 12px; border-radius: 4px; border: 1px solid var(--border-color); }
        .reply-form { margin-top: 10px; display: none; background: #f1f3f4; padding: 15px; border-radius: 4px; }

        .system-msg { padding: 20px; text-align: center; color: var(--text-secondary); font-size: 0.95rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-area">
        <h1>å°ˆæ¥­äº¤æµè«–å£‡</h1>
        <input type="text" id="searchInput" class="search-bar" placeholder="é—œéµå­—æœå°‹..." oninput="filterPosts()">
    </div>

    <div class="panel">
        <h3 style="margin-top:0; font-size:1.1rem;">ç™¼èµ·æ–°è¨è«–</h3>
        <div class="form-grid">
            <div>
                <label>æš±ç¨± (å¿…å¡«)</label>
                <input type="text" id="p_nickname" placeholder="è¼¸å…¥æš±ç¨±">
            </div>
            <div>
                <label>æ€§åˆ¥</label>
                <select id="p_gender">
                    <option value="ä¸é€éœ²">ä¸é€éœ²</option>
                    <option value="ç”·">ç”·</option>
                    <option value="å¥³">å¥³</option>
                </select>
            </div>
            <div>
                <label>è·ç¨±</label>
                <input type="text" id="p_job" placeholder="ä¾‹å¦‚ï¼šå·¥ç¨‹å¸« (æˆ–ä¸å¡«)">
            </div>
            <div>
                <label>å¹´é½¡</label>
                <select id="p_age">
                    <option value="ä¸é€éœ²">ä¸é€éœ²</option>
                    <option value="20æ­²ä»¥ä¸‹">20æ­²ä»¥ä¸‹</option>
                    <option value="21-30æ­²">21-30æ­²</option>
                    <option value="31-40æ­²">31-40æ­²</option>
                    <option value="41æ­²ä»¥ä¸Š">41æ­²ä»¥ä¸Š</option>
                </select>
            </div>
            <div>
                <label>å±…ä½åœ°</label>
                <input type="text" id="p_location" placeholder="ä¾‹å¦‚ï¼šå°åŒ—å¸‚ (æˆ–ä¸å¡«)">
            </div>
        </div>
        <div style="margin-bottom: 12px;">
            <label>è¨è«–å…§å®¹ (æ”¯æ´è²¼ä¸Šå¤–éƒ¨ç¶²å€)</label>
            <textarea id="p_content" placeholder="è«‹æè¿°æ‚¨æƒ³è¨è«–çš„å•é¡Œæˆ–åˆ†äº«çš„è³‡è¨Š..."></textarea>
        </div>
        <div style="margin-bottom: 16px;">
            <label>ä¸Šå‚³åœ–ç‰‡æˆ–å½±ç‰‡ (å–®æ¬¡ç¸½å®¹é‡å»ºè­°å°æ–¼ 25MB)</label>
            <input type="file" id="p_files" multiple accept="image/*,video/*" style="font-size: 0.85rem;">
        </div>
        <button id="btnSubmitPost" onclick="submitPost()">ç™¼ä½ˆæ–‡ç« </button>
    </div>

    <div id="loadingMsg" class="system-msg">è¼‰å…¥è³‡æ–™ä¸­ï¼Œè«‹ç¨å€™...</div>
    <div id="postsContainer"></div>
</div>

<script>
    // ğŸš¨ è«‹æ›æˆä½ å‰›å‰›å»ºç«‹æ–°ç‰ˆæœ¬çš„ GAS ç¶²å€
    const API_URL = 'https://script.google.com/macros/s/AKfycbyU_lnLanA0H7akOYZAmotFQuB5KSifEZx0fB2VV3MpNtHewBPvSWLlKK43Od5lgzhxfQ/exec';
    let allData = [];

    window.onload = loadPosts;

    async function loadPosts() {
        try {
            const res = await fetch(`${API_URL}?action=getPosts`);
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            allData = data;
            renderPosts(allData);
        } catch (e) {
            document.getElementById('loadingMsg').innerText = "è¼‰å…¥å¤±æ•—ï¼š" + e.message;
        }
    }

    // æ¸²æŸ“ç•«é¢é‚è¼¯ (ä¸»æ–‡èˆ‡å›è¦†åˆ†é›¢çµ„åˆ)
    function renderPosts(dataArray) {
        const container = document.getElementById('postsContainer');
        container.innerHTML = '';
        document.getElementById('loadingMsg').style.display = 'none';

        // åˆ†é›¢ä¸»æ–‡èˆ‡å›è¦†
        const mainPosts = dataArray.filter(p => !p.parentID);
        const replies = dataArray.filter(p => p.parentID);

        if (mainPosts.length === 0) {
            container.innerHTML = '<div class="system-msg">ç›®å‰é‚„æ²’æœ‰ä»»ä½•è¨è«–ï¼Œä¾†ç™¼ç¬¬ä¸€ç¯‡æ–‡ç« å§ï¼</div>';
            return;
        }

        mainPosts.forEach(post => {
            // è™•ç†åª’é«”é¡¯ç¤º
            let mediaHtml = '';
            if (post.media && post.media.length > 0) {
                post.media.forEach(m => {
                    if (m.isAutoVideo) {
                        mediaHtml += `<iframe src="https://drive.google.com/file/d/${m.id}/preview" allowfullscreen></iframe>`;
                    } else {
                        mediaHtml += `<img src="https://lh3.googleusercontent.com/d/${m.id}" alt="${m.name}">`;
                    }
                });
            }

            // å°‹æ‰¾å±¬æ–¼é€™ç¯‡è²¼æ–‡çš„å›è¦†
            const postReplies = replies.filter(r => r.parentID === post.postID);
            let repliesHtml = '';
            postReplies.forEach(r => {
                repliesHtml += `
                    <div class="reply-item">
                        <div class="post-meta" style="margin-bottom:4px;">
                            <strong>${r.nickname}</strong>
                            <span class="tag">${r.jobTitle}</span>
                            <span class="post-time">${formatDate(r.timestamp)}</span>
                        </div>
                        <div class="post-content" style="margin-bottom:0; font-size:0.95rem;">${escapeHtml(r.content)}</div>
                    </div>
                `;
            });

            const html = `
                <div class="panel">
                    <div class="post-meta">
                        <strong>${post.nickname}</strong>
                        <span class="tag">${post.gender}</span>
                        <span class="tag">${post.jobTitle}</span>
                        <span class="tag">${post.age}</span>
                        <span class="tag">${post.location}</span>
                        <span class="post-time">${formatDate(post.timestamp)}</span>
                    </div>
                    <div class="post-content">${linkify(escapeHtml(post.content))}</div>
                    ${mediaHtml ? `<div class="media-container">${mediaHtml}</div>` : ''}
                    
                    <div>
                        <button class="btn-secondary" onclick="toggleReplyForm('${post.postID}')">å›è¦†è¨è«– (${postReplies.length})</button>
                    </div>

                    <div class="reply-section">
                        ${repliesHtml}
                        
                        <div id="reply-form-${post.postID}" class="reply-form form-grid" style="display:block; margin-top:15px; border-top:1px solid #ccc; padding-top:15px;">
                            <input type="text" id="r_nickname_${post.postID}" placeholder="æ‚¨çš„æš±ç¨± (å¿…å¡«)">
                            <input type="text" id="r_job_${post.postID}" placeholder="è·ç¨± (é¸å¡«)">
                            <textarea id="r_content_${post.postID}" placeholder="å¯«ä¸‹æ‚¨çš„å›è¦†..." style="grid-column: 1 / -1;"></textarea>
                            <button onclick="submitReply('${post.postID}')" style="grid-column: 1 / -1;">é€å‡ºå›è¦†</button>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += html;
            // é è¨­éš±è—å›è¦†è¡¨å–®ï¼Œä¿æŒç•«é¢ä¹¾æ·¨
            document.getElementById(`reply-form-${post.postID}`).style.display = 'none';
        });
    }

    function toggleReplyForm(id) {
        const form = document.getElementById(`reply-form-${id}`);
        form.style.display = form.style.display === 'none' ? 'grid' : 'none';
    }

    // ç™¼ä½ˆä¸»æ–‡
    async function submitPost() {
        const nickname = document.getElementById('p_nickname').value.trim();
        const content = document.getElementById('p_content').value.trim();
        const fileInput = document.getElementById('p_files');
        
        if (!nickname || !content) return alert("æš±ç¨±èˆ‡å…§å®¹ç‚ºå¿…å¡«ï¼");
        
        const btn = document.getElementById('btnSubmitPost');
        btn.innerText = "ä¸Šå‚³è™•ç†ä¸­...";
        btn.disabled = true;

        try {
            const filesData = await processFiles(fileInput.files);
            
            const payload = {
                action: 'addPost',
                payload: {
                    nickname: nickname,
                    gender: document.getElementById('p_gender').value,
                    jobTitle: document.getElementById('p_job').value || 'ä¸é€éœ²',
                    age: document.getElementById('p_age').value,
                    location: document.getElementById('p_location').value || 'ä¸é€éœ²',
                    content: content,
                    files: filesData
                }
            };
            await sendToServer(payload);
            alert("ç™¼ä½ˆæˆåŠŸï¼");
            location.reload();
        } catch (e) {
            alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + e);
            btn.innerText = "ç™¼ä½ˆæ–‡ç« ";
            btn.disabled = false;
        }
    }

    // ç™¼ä½ˆå›è¦†
    async function submitReply(parentID) {
        const nickname = document.getElementById(`r_nickname_${parentID}`).value.trim();
        const content = document.getElementById(`r_content_${parentID}`).value.trim();
        const job = document.getElementById(`r_job_${parentID}`).value.trim() || 'ä¸é€éœ²';
        
        if (!nickname || !content) return alert("æš±ç¨±èˆ‡å›è¦†å…§å®¹ç‚ºå¿…å¡«ï¼");
        
        const payload = {
            action: 'addPost',
            payload: {
                parentID: parentID,
                nickname: nickname,
                jobTitle: job,
                content: content,
                // å›è¦†æš«ä¸é–‹æ”¾å‚³åœ–ï¼Œä¿æŒè¼•é‡
                files: []
            }
        };
        
        try {
            await sendToServer(payload);
            alert("å›è¦†æˆåŠŸï¼");
            location.reload();
        } catch (e) {
            alert("å›è¦†å¤±æ•—ï¼š" + e);
        }
    }

    // å°‡æª”æ¡ˆè½‰æ›ç‚º Base64 (GAS å¿…éœ€)
    async function processFiles(files) {
        let result = [];
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const base64 = await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            result.push({ name: file.name, mimeType: file.type, base64: base64 });
        }
        return result;
    }

    // è² è²¬èˆ‡ GAS æºé€š
    async function sendToServer(data) {
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.error) throw new Error(result.error);
        return result;
    }

    // é—œéµå­—æœå°‹éæ¿¾ (æ¯”å°æš±ç¨±ã€å…§å®¹)
    function filterPosts() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        if (!query) return renderPosts(allData);
        
        const filtered = allData.filter(p => 
            (p.nickname && p.nickname.toLowerCase().includes(query)) || 
            (p.content && p.content.toLowerCase().includes(query)) ||
            (p.jobTitle && p.jobTitle.toLowerCase().includes(query))
        );
        renderPosts(filtered);
    }

    // å·¥å…·å‡½å¼ï¼šé˜² XSS æ”»æ“Šèˆ‡ç¶²å€è‡ªå‹•è½‰æ›é€£çµ
    function escapeHtml(text) { return text.replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
    function linkify(text) {
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, function(url) {
            return `<a href="${url}" target="_blank" style="color:#1a73e8;">${url}</a>`;
        });
    }
    function formatDate(dateStr) {
        try { const d = new Date(dateStr); return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`; } catch(e){ return dateStr; }
    }
</script>

</body>
</html>
